<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
<script src="ajax.js"></script>
<script src="api.js"></script>
<script>
    var timer=null;
    var timer_count=0;
    zcbDepositNew({
        amount:1,//充值金额 元
        redirect_url:"http://test.jubao56.com/m/#/",
        type:2  //订单类型，0-web支付，1-微信支付，2-支付宝支付
    },function (res) {
        if (res.err_code !== 0) {Toast({message: res.err_msg || '未知错误'});return;}
        window.open(res.data.pay_url);
        checkOrderStatus(res.data.id)//计时器监测是否调用成功
    },function (err) {
        console.log(err);
    });

    function checkOrderStatus(order_id) {
        clearInterval(timer);
        timer=setInterval(function () {
            timer_count++;
            zcbDepositInfo({order_id:order_id},function (response) {
                if (response.err_code !== 0) {Toast({message: res.err_msg || '未知错误'});clearInterval(timer);orderPayFail(response);return;}
                if(response.data.status===2){//订单已支付时，通知app支付成功
                    timer_count=0;
                    clearInterval(timer);
                    orderPayed(response);
                }
                if(timer_count>=60){//超时60s时，通知app支付可能没有成功，请用户等待几分钟后再支付
                    timer_count=0;
                    clearInterval(timer);
                    orderPayFail(response);
                }
            },function (err) {
                console.log(err);
            })
        },1000)
    }

    //这是必须要写的，用来初始化一些设置
    function setupWebViewJavascriptBridge(callback) {
        if (window.WebViewJavascriptBridge) { return callback(WebViewJavascriptBridge); }
        if (window.WVJBCallbacks) { return window.WVJBCallbacks.push(callback); }
        window.WVJBCallbacks = [callback];
        var WVJBIframe = document.createElement('iframe');
        WVJBIframe.style.display = 'none';
        WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__';
        document.documentElement.appendChild(WVJBIframe);
        setTimeout(function() { document.documentElement.removeChild(WVJBIframe) }, 0)
    }

    //这也是固定的， OC 调JS ， 需要给OC调用的函数必须写在这个函数里面
    setupWebViewJavascriptBridge(function(bridge) {
        bridge.registerHandler('testJSFunction', function(data, responseCallback) {
            alert('JS方法被调用:'+data);
            responseCallback('js执行过了');
        })
        function orderPayed(response) {
            console.log(response,"订单已经成功")
        }
        function orderPayFail(response) {
            console.log(response,"订单支付失败")
        }
    })

    //这个 shareClick 就是 原生那边 注入的函数 ， 通过这个方法来调用原生 和传值
    //parmas 是JS 给OC的数据 ， response 是 OC函数被调用之后 再 告诉JS 我被调用了
    //比如微信分享，给Dic给原生 ， 原生分享成功后再把结果回调给JS 进行处理
    function shareClick() {
        var params = {'title':'测试分享的标题','content':'测试分享的内容','url':'http://www.baidu.com'};
        WebViewJavascriptBridge.callHandler('shareClick',params,function(response) {

            console.log(response);

        });
    }
</script>
</html>