<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_514054_44qysw76w0tqpvi.css">
    <title>整车保订单支付</title>
</head>
<body>
<!--保付支付模块  start-->
<div class="pay">
    {{msg}}<br/>
    <vue-dialog></vue-dialog>
    <!--<div class="all" v-show="flag">-->
        <!--&lt;!&ndash;<div class="header">在线支付</div>&ndash;&gt;-->
        <!--<div title="在线支付" backIcon="icon-cancel" :backUrl="cancelLink"></div>-->
        <!--<div class="header_repeat"></div>-->
        <!--<div class="content">-->
            <!--<ul>-->
                <!--<li class="title">选择支付方式：</li>-->
                <!--<li @click="payType=2"><i class="iconfont icon-zhifubao"></i><span class="txt">支付宝</span><i class="iconfont radio" :class="payType===2?'icon-duigou':'icon-yuan'"></i></li>-->
                <!--<li @click="payType=1"><i class="iconfont icon-weixin"></i><span class="txt">微信</span><i class="iconfont radio" :class="payType===1?'icon-duigou':'icon-yuan'"></i></li>-->
            <!--</ul>-->
        <!--</div>-->
        <!--<div class="bottom" @click="confrimPay" v-touchFeel>-->
            <!--确认支付{{price | showPrice}}-->
        <!--</div>-->
    <!--</div>-->

    <!--<div class="bg" @click="close" v-show="flag"></div>-->

</div>
<!--保付支付模块  end-->
<button type="button" onclick="orderPay()">订单支付</button>
</body>
<script src="jquery.min.js"></script>
<script src="vue.min.js"></script>
<script src="data.js"></script>
<script src="commonJs.js"></script>
<script src="api.js"></script>
<script src="vuePay.js"></script>
<script>
    //参数设置，页面上所有需要设置的参数均在此处设置
    var paramsInit={
        amount:1,//充值金额 元;                                             //{type:Number}   单位：元[￥]
        payType:2, //订单类型，0-web支付，1-微信支付，2-支付宝支付;         //{type:Number}   可选参数[0,1,2]
        redirectUrl:"http://test.jubao56.com/m/#/", //重定向页面地址    //{type:String}
        space:1000,//计时器发送请求的时间间隔                               //{type:Number}   单位：毫秒[ms]
        timeout:60,//设置超时时间，XX秒后判定为超时;                        //{type:Number}  单位：秒[s]
        success:"orderPayed", //与app端约定的，订单支付成功后，即时调用的函数名    //{type:String}
        fail:"orderPayFail",  //与app端约定的，订单判定支付失败后，即时调用的函数   //{type:String}
        baofuPayType:1,         //宝付订单产品类型     //{type:Number},可选参数[1,2，4，8，16，32，64]   1代表整车保充值支付
    };


    var timer=null;
    var timerCount=0;
    function tpOrderPay(bridge) {   //太平支付
        zcbDepositNew({
            amount:paramsInit.amount,//充值金额 元
            redirect_url:paramsInit.redirectUrl,
            type:paramsInit.payType  //订单类型，0-web支付，1-微信支付，2-支付宝支付
        },function (res) {
            if(res===""){bfOrderPay(bridge);return ;}  //太平返回值为空，则调用保付支付
            if (res.err_code !== 0) {Toast({message: res.err_msg || '未知错误'});return;}
            checkOrderStatus(res.data.id,bridge);//计时器监测是否调用成功
            window.open(res.data.pay_url);
        },function (err) {
            console.log(err);
        });
    }

    function bfOrderPay(bridge) {   //保付支付
        //整车保,预约货运万能保应急充值,可以不传order_id,其他情况必须传
        cmnBaofuPayurl({
            amount:paramsInit.amount,//交易金额          //{type:Number},单位：分
            pay_type:getBaofuPayType(), //支付类型：1-微信，2-支付宝   //{type:Number},可选参数[1,2]
            product_type:paramsInit.baofuPayType  //宝付订单产品类型     //{type:Number},可选参数[1,2，4，8，16，32，64]
        })
    }

    function getBaofuPayType() {

    }

    function checkOrderStatus(orderId,bridge) {
        clearInterval(timer);
        timer=setInterval(function () {
            timerCount++;
            Toast(timerCount)
            zcbDepositInfo({order_id:orderId},function (resp) {
                if (resp.err_code !== 0) {Toast({message: res.err_msg || '未知错误'});clearInterval(timer);orderPayFail(resp);return;}
                if(resp.data.status===2){//订单已支付时，通知app支付成功
                    timerCount=0;
                    clearInterval(timer);
                    bridge.callHandler('orderPayed', {response:resp}, function(response) {
                        Toast(response)
                    })
                }
                if(timerCount>=paramsInit.timeout){//超时60s时，通知app支付可能没有成功，请用户等待几分钟后再支付
                    timerCount=0;
                    clearInterval(timer);
                    bridge.callHandler('orderPayFail', {response:resp}, function(response) {
                        Toast(response)
                    })
                }
            },function (err) {
                console.log(err);
            })
        },paramsInit.space)
    }

    //这是必须要写的，用来初始化一些设置
    function setupWebViewJavascriptBridge(callback) {
        if (window.WebViewJavascriptBridge) { return callback(WebViewJavascriptBridge); }
        if (window.WVJBCallbacks) { return window.WVJBCallbacks.push(callback); }
        window.WVJBCallbacks = [callback];
        var WVJBIframe = document.createElement('iframe');
        WVJBIframe.style.display = 'none';
        WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__';
        document.documentElement.appendChild(WVJBIframe);
        setTimeout(function() { document.documentElement.removeChild(WVJBIframe) }, 0)
    }

    //这也是固定的， OC 调JS ， 需要给OC调用的函数必须写在这个函数里面
    setupWebViewJavascriptBridge(function(bridge) {
        tpOrderPay(bridge);//订单支付开始
    })


</script>
</html>