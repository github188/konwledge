<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/cart.css">
	</head>
	<body>
		
		<div class="top">
			<img src="img/cart-top1.png" alt="" />
		</div>
		<div class="container">
			<table class="table">
				<thead>
					<tr>
						<th class="select-all-box"><input type="checkbox" class="select-all"/><span>全选</span></th>
						<th class="goods-name">商品</th>
						<th class="goods-type"></th>
						<th class="goods-type">单价</th>
						<th class="goods-type option">数量</th>
						<th class="goods-type">小计</th>
						<th class="goods-type">操作</th>
					</tr>
				</thead>
				<tbody class="list-wrap">
					
				</tbody>
			</table>
			<div class="other-option">
				<div class="left">
					<div class="item select">
						<input type="checkbox" class="select-all"/><span>全选</span>
					</div>
					<a class="item delete-select" href="javascript:;">删除选中的商品</a>
				</div>
				<div class="right">
					<div class="item ">
						已选择<span class="total-select">0</span>件商品
					</div>
					<div class="item ">
						总价为￥<span class="total-money">0.00</span>
					</div>
					<div class="item go-pay">去结算</div>
				</div>
			</div>
		</div>
		
		
		<script src="js/jquery-1.11.3.js"></script>
		<script src="js/layer.js"></script>
		<script src="js/template.js"></script>
		
		<script id="cart-list" type="text/html">
			{{ each data as v}}
				<tr data-id="{{v.id}}">
					<td class="select-box"><input type="checkbox" class="select"/></td>
					<td class="goods-name">
						<img src="{{v.goods_pic_m}}">
						<span>{{v.goods_name}}</span>
						<p>&nbsp;</p>
						<p>&nbsp;</p>
					</td>
					<td class="goods-type">{{v.goods_type}}</td>
					<td class="goods-price">{{v.goods_price}}</td>
					<td class="goods-amount option">
						<a href="javascript:;" class="option-item option-decrease">-</a>
						<input class="option-item option-input"type="text" value="{{v.amount}}" data-stock="{{v.goods_stock}}">
						<a href="javascript:;" class="option-item option-increase">+</a>
					</td>
					
					<td class="goods-total">{{ (v.goods_price * v.amount).toFixed(2) }}</td>
					<td class="goods-option">
						<a href="javascript:;" class="delete">删除</a>
					</td>
				</tr>
			{{ /each }}
		</script>
		
		<script>
			$(function(){
				var cart = {
					init: function(){
						this.initList();
						
						this.increase();
						this.decrease();
						this.input();
						
						this.deleteClick();
						this.deleteSelect();
						
						this.select();
						this.selectAll();
					},
					initList: function(){
						//通过ajax获取
						$.ajax({
							url: 'http://192.168.55.44/PC-Project-Admin/cartList.php',
							dataType: 'jsonp',
							success: function(result){
								//console.log(result.data[0]);
								var html = template('cart-list',result);
								$('.list-wrap').html(html);
							}
						});
					},
					increase: function(){
						var _this = this;
						$('.list-wrap').on('click','.option-increase',function(){
							//获取id、stock、amount
							var 
								id = $(this).parents('tr').data('id'),
								stock = $(this).prev().data('stock'),
								amount = $(this).prev().val();
							
							if(amount >= stock){
								return;
							}
							
							amount++;
							
							_this.update(id,amount);
						});
					},
					decrease: function(){
						var _this = this;
						$('.list-wrap').on('click','.option-decrease',function(){
							//获取id、stock、amount
							var 
								id = $(this).parents('tr').data('id'),
								amount = $(this).next().val();
							
							if(amount <= 1){
								return;
							}
							
							amount--;
							
							_this.update(id,amount);
						});
					},
					input: function(){
						var _this = this;
						$('.list-wrap').on('input','.option-input',function(){
							var 
								id = $(this).parents('tr').data('id'),
								stock = $(this).data('stock'),
								amount = $(this).val();
							
							if(amount >= stock){
								return;
							}
							
							_this.update(id,amount);
						});
					},
					deleteClick: function(){
						//保留对象
						var _this = this;
						$('.list-wrap').on('click','.delete',function(){
							//保留元素
							var self = this;
							var cfm = layer.confirm('确定删除宝贝吗？',['确定','取消'],function(){
								layer.close(cfm);
								var id = $(self).parents('tr').data('id');
								_this.delete(id);
							});
						});
					},
					deleteSelect: function(){
						var _this = this;
						$('.delete-select').click(function(){
							var select = $('input.select:checked');
							if(!select.length){
								layer.alert('请选择需要删除的记录！');
								return;
							}
							if(!confirm('确定删除选中的记录吗？')){
								return ;
							}
							var ids = [];
							select.each(function(){
								var id = $(this).parents('tr').data('id');
								ids.push(id);
							});
							_this.delete(ids);
						});
					},
					//单选
					select: function(){
						$('.list-wrap').on('change','input.select',function(){
							
							var 
								allTr = $('.list-wrap tr'),
								count = 0,
								totalMoney = 0;
							
							allTr.each(function(){
								var status = $(this).find('input').prop('checked');
								//当前行被选中了
								if(status){
									count++;
									var t = $(this).find('.goods-total').html();
									totalMoney += parseFloat(t);
								}
							});
							
							//更改选中商品的条数和总价
							$('.total-select').html(count);
							$('.total-money').html(totalMoney.toFixed(2));
							
							//处理选中状态
							var selectTotal = $('input.select:checked').length;
							var inputTotal = $('input.select').length;
							
							if(selectTotal != inputTotal){
								$('input.select-all').prop('checked',false);
							}else{
								$('input.select-all').prop('checked',true);
							}
						});
					},
					//全选
					selectAll: function(){
						$('input.select-all').click(function(){
							var status = $(this).prop('checked');
							$('input.select-all').prop('checked',status);
							$('input.select').prop('checked',status);
							
							//触发点击事件
							$('input.select').change();
						});
					},
					//删除  接口
					delete: function(id){
						var _this = this;
						$.ajax({
							url: 'http://192.168.55.44/PC-Project-Admin/cartDelete.php',
							data: {
								id: id
							},
							dataType: 'jsonp',
							success: function(){
								//数据同步
								_this.initList();
								//初始化总价和选中的总个数
								$('.total-select').html(0);
								$('.total-money').html('0.00');
							}
						});
					},
					update: function(id,amount){
						var _this = this;
						var ld = layer.load(2);
						$.ajax({
							url: 'http://192.168.55.44/PC-Project-Admin/cartUpdate.php',
							data: {
								id: id,
								amount: amount
							},
							dataType: 'jsonp',
							success: function(data){
								//layer.alert(data.info);
								layer.close(ld);
								//数据同步
								_this.initList();
							}
						});
					}
				};
				cart.init();
			});
		</script>
	</body>
</html>
